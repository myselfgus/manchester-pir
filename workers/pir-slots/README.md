# HealthOS Slot Extractor

**Sistema Operacional de Sa√∫de AI-Native** - Extra√ß√£o conversacional de slots cl√≠nicos usando LLMs como sistema operacional.

## üß¨ Arquitetura Rizom√°tica

O HealthOS implementa uma **arquitetura rizom√°tica n√£o-hier√°rquica**:

- **18 Agentes LLM Especializados** rodando em paralelo
- Cada agente extrai um slot espec√≠fico autonomamente
- Sem hierarquia: todos processam simultaneamente o contexto conversacional
- Coordena√ß√£o descentralizada via orquestrador

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Audio/Text Input   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Whisper STT (CF AI) ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ     Rhizomatic Orchestrator (Paralelo)      ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò
               ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê ‚îå‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚ñº‚îÄ‚îÄ‚îê ‚îå‚ñº‚îÄ‚îÄ‚îê ‚îå‚ñº‚îÄ‚îÄ‚îê
        ‚îÇChief    ‚îÇ ‚îÇPain ‚îÇ ‚îÇTemp ‚îÇ ‚îÇBP ‚îÇ ‚îÇO2 ‚îÇ ‚îÇ...‚îÇ
        ‚îÇComplaint‚îÇ ‚îÇScore‚îÇ ‚îÇ     ‚îÇ ‚îÇ   ‚îÇ ‚îÇ   ‚îÇ ‚îÇ   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îò
             18 Extractors LLM Simult√¢neos
```

## üéØ Conceitos Fundamentais

### AI-Native Healthcare OS

O HealthOS trata **LLMs como sistema operacional**, n√£o como ferramentas:

- **Cada slot = Um processo (agente LLM)**
- **Extra√ß√£o paralela = Multitasking rizom√°tico**
- **Conversa√ß√£o = Interface natural** (n√£o formul√°rios)
- **Automa√ß√£o total da burocracia** via IA

### Extra√ß√£o Conversacional

Todos os 18 slots s√£o extra√≠dos de **conversa natural** entre enfermeiro e paciente:

- ‚úÖ **Audio ‚Üí STT (Whisper) ‚Üí LLM ‚Üí Dados estruturados**
- ‚ùå Sem formul√°rios
- ‚ùå Sem clicks
- ‚ùå Sem campos obrigat√≥rios

Exemplo:
```
Paciente: "Estou com uma dor terr√≠vel no peito h√° 2 horas,
           parece que est√° apertando"

HealthOS extrai automaticamente:
- chief_complaint: "dor tor√°cica"
- pain_score: 8
- symptom_onset: {duration: 2, unit: "hours"}
- chest_pain_characteristics: {precordial: true, ...}
```

## üìã 18 Slots Implementados

### Conversacionais (LLM Extraction)
1. **chief_complaint** - Queixa principal
2. **pain_score** - Escala de dor (0-10)
3. **consciousness_level** - N√≠vel de consci√™ncia (AVPU)
4. **bleeding_present** - Presen√ßa de hemorragia
5. **bleeding_severity** - Gravidade da hemorragia
6. **symptom_onset** - H√° quanto tempo come√ßou
7. **trauma_mechanism** - Mecanismo do trauma
8. **neurological_deficit** - D√©ficit neurol√≥gico (FAST)
9. **chest_pain_characteristics** - Caracter√≠sticas da dor tor√°cica

### Device-Based (Medi√ß√µes + LLM Parsing)
10. **temperature** - Temperatura corporal
11. **heart_rate** - Frequ√™ncia card√≠aca
12. **blood_pressure** - Press√£o arterial (sist√≥lica/diast√≥lica)
13. **oxygen_saturation** - SpO2
14. **respiratory_rate** - Frequ√™ncia respirat√≥ria
15. **glucose_level** - Glicemia capilar

### Historical (RMS + LLM)
16. **previous_medical_history** - Hist√≥ria m√©dica pregressa
17. **medications_in_use** - Medica√ß√µes em uso
18. **allergy_history** - Alergias (CR√çTICO)

### Computed (Algoritmos)
19. **sepsis_criteria** - qSOFA score + suspeita infec√ß√£o

## üöÄ API Endpoints

### Iniciar Sess√£o de Triagem
```http
POST /api/triage/start

Request:
{
  "patient_id": "optional-patient-id",
  "patient_context": {
    "age": 45,
    "sex": "M",
    "medical_history": ["diabetes", "hipertens√£o"]
  }
}

Response:
{
  "success": true,
  "session_id": "uuid-v4",
  "session": {...}
}
```

### Processar √Åudio (STT + Extra√ß√£o)
```http
POST /api/triage/:sessionId/audio?speaker=patient

Content-Type: multipart/form-data
Body: audio file (wav, mp3, webm)

Response:
{
  "success": true,
  "transcription": "Estou com dor no peito h√° 2 horas",
  "extracted_slots": {
    "chief_complaint": {
      "value": "dor tor√°cica",
      "confidence": 0.95,
      "source": "llm_extraction"
    },
    "pain_score": {
      "value": null,
      "confidence": 0.0
    },
    ...
  },
  "progress": {
    "filled_slots": 5,
    "total_slots": 18,
    "completion_percentage": 28
  }
}
```

### Processar Texto (Chat Interface)
```http
POST /api/triage/:sessionId/text

Request:
{
  "text": "A dor √© de 8 na escala de 0 a 10",
  "speaker": "patient"
}

Response: (mesma estrutura do /audio)
```

### Obter Pr√≥xima Pergunta Inteligente
```http
GET /api/triage/:sessionId/next-question

Response:
{
  "success": true,
  "next_question": {
    "slot_id": "temperature",
    "question": "Qual a temperatura do paciente?",
    "priority": "critical",
    "reasoning": "Slot temperature is unfilled and has critical priority"
  }
}
```

### Status da Sess√£o
```http
GET /api/triage/:sessionId/status

Response:
{
  "success": true,
  "session": {
    "session_id": "uuid",
    "started_at": "2024-03-15T10:30:00Z",
    "status": "active",
    "conversation_history": [...],
    "slot_state": {
      "chief_complaint": "dor tor√°cica",
      "pain_score": 8,
      ...
    }
  }
}
```

### Atualizar Slot Manualmente
```http
PUT /api/triage/:sessionId/slots/pain_score

Request:
{
  "value": 7
}
```

### For√ßar Re-extra√ß√£o de Slot
```http
POST /api/triage/:sessionId/slots/temperature/extract

Response:
{
  "success": true,
  "slot_id": "temperature",
  "extraction_result": {
    "value": 38.5,
    "confidence": 0.9,
    ...
  }
}
```

### Finalizar Triagem
```http
POST /api/triage/:sessionId/complete

Response:
{
  "success": true,
  "session": {...},
  "filled_slots": {...},
  "progress": {
    "completion_percentage": 94
  },
  "pir_export": {
    "session_id": "uuid",
    "slots": {...},
    "conversation_transcript": [...]
  }
}
```

## üß™ Exemplos de Uso

### Exemplo 1: Triagem Completa com √Åudio

```javascript
// 1. Inicia sess√£o
const session = await fetch('https://healthos.voither.com/api/triage/start', {
  method: 'POST',
  body: JSON.stringify({ patient_id: '12345' })
}).then(r => r.json());

const sessionId = session.session_id;

// 2. Captura √°udio do microfone e envia
navigator.mediaDevices.getUserMedia({ audio: true })
  .then(stream => {
    const mediaRecorder = new MediaRecorder(stream);
    const audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks);
      const formData = new FormData();
      formData.append('audio', audioBlob);

      const result = await fetch(
        `https://healthos.voither.com/api/triage/${sessionId}/audio?speaker=patient`,
        { method: 'POST', body: formData }
      ).then(r => r.json());

      console.log('Extracted:', result.extracted_slots);
      console.log('Progress:', result.progress);
    };

    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 5000); // 5 segundos
  });

// 3. Pergunta inteligente
const nextQ = await fetch(
  `https://healthos.voither.com/api/triage/${sessionId}/next-question`
).then(r => r.json());

console.log('Next:', nextQ.next_question.question);

// 4. Finaliza
const final = await fetch(
  `https://healthos.voither.com/api/triage/${sessionId}/complete`,
  { method: 'POST' }
).then(r => r.json());

console.log('PIR Export:', final.pir_export);
```

### Exemplo 2: Interface Chat (Texto)

```javascript
const sessionId = 'existing-session-uuid';

// Paciente fala
await fetch(`https://healthos.voither.com/api/triage/${sessionId}/text`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    text: 'Estou com febre h√° 3 dias e tosse',
    speaker: 'patient'
  })
});

// Sistema sugere pr√≥xima pergunta
const next = await fetch(
  `https://healthos.voither.com/api/triage/${sessionId}/next-question`
).then(r => r.json());

// Enfermeira faz pergunta sugerida
await fetch(`https://healthos.voither.com/api/triage/${sessionId}/text`, {
  method: 'POST',
  body: JSON.stringify({
    text: next.next_question.question,
    speaker: 'nurse'
  })
});
```

## üèóÔ∏è Arquitetura T√©cnica

### Stack
- **Runtime**: Cloudflare Workers (Edge Computing)
- **STT**: Cloudflare Workers AI - Whisper (@cf/openai/whisper)
- **LLM**: Llama 3.1 8B Instruct (@cf/meta/llama-3.1-8b-instruct)
- **Storage**: Cloudflare KV (sess√µes)
- **Language**: TypeScript (strict mode)

### Componentes

#### 1. STT/ASR Layer ([whisper-worker.ts](src/stt/whisper-worker.ts))
- Transcri√ß√£o de √°udio para texto
- Suporte a streaming
- Speaker diarization simples

#### 2. Base Extractors ([base-extractor.ts](src/extractors/base-extractor.ts))
- `BaseSlotExtractor<T>` - Classe base abstrata
- `ConversationalExtractor<T>` - Para slots conversacionais
- `DeviceExtractor<T>` - Para sinais vitais
- `ComputedExtractor<T>` - Para slots calculados

#### 3. Concrete Extractors
- [conversational-slots.ts](src/extractors/conversational-slots.ts) - 9 extractors conversacionais
- [device-computed-slots.ts](src/extractors/device-computed-slots.ts) - 10 extractors device/computed

#### 4. Orchestrator ([rhizomatic-orchestrator.ts](src/orchestrator/rhizomatic-orchestrator.ts))
- Gerencia sess√µes de triagem
- Dispara 18 extractors em paralelo
- Calcula progresso
- Gera perguntas inteligentes de fallback

#### 5. Worker Entry Point ([index.ts](src/index.ts))
- API HTTP REST
- Roteamento
- CORS
- Persist√™ncia KV

### Fluxo de Dados

```
Audio/Text Input
    ‚Üì
STT (Whisper) ‚Üí Transcription
    ‚Üì
Rhizomatic Orchestrator
    ‚Üì
Promise.all([
  extractor1.extract(),
  extractor2.extract(),
  ...
  extractor18.extract()
]) ‚Üê PARALELO
    ‚Üì
Slot State Update
    ‚Üì
Progress Calculation
    ‚Üì
Response JSON
```

## üìä Performance

### Lat√™ncia T√≠pica
- **STT (Whisper)**: ~200-500ms por chunk de 3-5 segundos
- **Extra√ß√£o Paralela (18 slots)**: ~800ms-2s (todos juntos)
- **Total por turno conversacional**: ~1-2.5 segundos

### Otimiza√ß√µes
- ‚úÖ Extra√ß√£o paralela (n√£o sequencial)
- ‚úÖ Edge computing (baixa lat√™ncia)
- ‚úÖ LLM local no edge (Llama 3.1 8B)
- ‚úÖ Streaming STT para conversas longas
- ‚úÖ Cache de contexto conversacional

## üöÄ Deploy

### Pr√©-requisitos
```bash
# Instala Wrangler CLI
npm install -g wrangler

# Login Cloudflare
wrangler login
```

### Configura√ß√£o

1. Cria KV Namespace:
```bash
wrangler kv:namespace create "SESSIONS_KV"
# Copia o ID e atualiza wrangler.toml
```

2. Atualiza `wrangler.toml`:
```toml
account_id = "SEU_ACCOUNT_ID"

[[kv_namespaces]]
binding = "SESSIONS_KV"
id = "SEU_KV_ID"
```

3. Deploy:
```bash
npm install
npm run deploy
```

### Desenvolvimento Local
```bash
npm run dev
# Servidor local em http://localhost:8787
```

## üîí Seguran√ßa & Compliance

### LGPD
- ‚úÖ Dados do paciente criptografados
- ‚úÖ Reten√ß√£o limitada (1 hora em KV por padr√£o)
- ‚úÖ Trilha de auditoria completa
- ‚úÖ Consentimento impl√≠cito por busca de atendimento

### PHI Protection
- ‚úÖ Dados sens√≠veis nunca em logs
- ‚úÖ Transmiss√£o HTTPS obrigat√≥ria
- ‚úÖ Isolamento por sess√£o
- ‚úÖ Cleanup autom√°tico ap√≥s finaliza√ß√£o

## üß© Integra√ß√£o com PIR Compiler

O HealthOS exporta dados no formato compat√≠vel com PIR:

```javascript
const pirData = orchestrator.exportToPIR(sessionId);

// Envia para PIR Compiler
await fetch('https://pir-compiler.voither.com/api/pir/compile', {
  method: 'POST',
  body: JSON.stringify({
    protocol_name: 'manchester-sp-2024',
    slots: pirData.slots,
    conversation_transcript: pirData.conversation_transcript
  })
});
```

## üéì Filosofia: LLMs como Sistema Operacional

O HealthOS inverte o paradigma tradicional:

### Paradigma Antigo
```
Sistema ‚Üí Formul√°rio ‚Üí Usu√°rio preenche ‚Üí Dados estruturados
```

### Paradigma HealthOS (AI-Native)
```
Conversa Natural ‚Üí LLMs (OS) ‚Üí Dados estruturados
```

**LLMs s√£o o sistema operacional:**
- Interpretam inten√ß√£o
- Extraem informa√ß√£o
- Estruturam dados
- Validam consist√™ncia
- Sugerem pr√≥ximos passos

**Humanos focam no que importa:**
- Cuidar do paciente
- Tomar decis√µes cl√≠nicas
- N√£o preencher formul√°rios

## üìù Licen√ßa

MIT License - Voither Team

## ü§ù Contribuindo

Pull requests s√£o bem-vindos! Para mudan√ßas maiores, abra uma issue primeiro.

## üìû Suporte

- Documenta√ß√£o: https://docs.voither.com/healthos
- Issues: https://github.com/voither/healthos/issues
- Email: dev@voither.com
